# Implementation Plan: Generic Provider Model for Market Data

**Branch**: `001-generic-provider-model` | **Date**: 2025-10-24 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/home/pete/git/stocktopus/specs/001-generic-provider-model/spec.md`

**Note**: This file is generated by the `/speckit.plan` command.

## Summary

Create a pluggable provider abstraction for market data sources that allows seamless switching between providers (Alpha Vantage, Polygon.io, Financial Modeling Prep) without changing screening logic. System will standardize metric names/units across providers, proactively adapt refresh rates to provider capabilities, and provide comprehensive error handling through TUI error panels. Initial implementation targets three provider tiers (amateur/professional/quantitative) with at least three concrete implementations.

## Technical Context

**Language/Version**: Go 1.22+
**Primary Dependencies**: Bubble Tea (TUI), gopher-lua (VM), HTTP client libraries for provider APIs, YAML config parser
**Storage**: Configuration files (YAML), no database required
**Testing**: Go testing framework (`go test`), table-driven tests for provider implementations
**Target Platform**: Linux/Mac/Windows terminal environments
**Project Type**: Single project (terminal application)
**Performance Goals**: Provider API calls <2s latency, TUI updates <100ms, support concurrent fetching for 50+ symbols
**Constraints**: No stale data (real-time only), exponential backoff for retries, proactive rate limiting to provider capabilities
**Scale/Scope**: Support 3-5 initial providers, standardize 10-15 core metrics, handle 100+ concurrent stock symbol requests

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

All features MUST comply with the Stocktopus Constitution (v1.0.0+). Verify:

- [x] **I. Interface-First**: StockProvider interface will abstract all provider implementations, enabling testing with mocks and easy addition of new providers
- [x] **II. Concurrent & Performant**: Provider API calls will use goroutines for concurrent symbol fetching, channels for result aggregation, rate limiters for throttling
- [x] **III. Test-First (NON-NEGOTIABLE)**: Contract tests for StockProvider interface will be written first, provider implementations will be test-driven with table tests
- [x] **IV. Integration Testing**: Contract tests for each provider implementation, integration tests for provider switching, VM integration with standardized metrics
- [x] **V. Observability**: Structured logging for provider selection/errors/API calls, TUI error panel for real-time user feedback, metrics for API latency and throttling
- [x] **VI. Versioning**: New StockProvider interface is a MINOR version bump (backward compatible with existing Polygon provider via adapter pattern)
- [x] **VII. Simplicity**: Single active provider at startup (multi-provider optional), simple rate limiting (no complex quota management), US markets only (defer international)

*No violations - all principles satisfied.*

## Project Structure

### Documentation (this feature)

```
specs/001-generic-provider-model/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```
internal/
├── provider/              # NEW: Provider abstraction and implementations
│   ├── provider.go        # StockProvider interface definition
│   ├── metrics.go         # Standardized metric types and normalization
│   ├── registry.go        # Provider registration and factory
│   ├── alphavantage/      # Alpha Vantage implementation
│   │   └── alphavantage.go
│   ├── polygon/           # EXISTING: Refactor to implement StockProvider
│   │   └── polygon.go
│   └── financialmodelingprep/  # Financial Modeling Prep implementation
│       └── fmp.go
├── config/                # EXISTING: Extend for provider configuration
│   └── config.go
├── tui/                   # EXISTING: Add error panel component
│   ├── view.go
│   └── error_panel.go     # NEW: Error/status display component
├── engine/                # EXISTING: Update to use StockProvider interface
│   └── engine.go
├── model/                 # EXISTING: Add standardized stock data model
│   ├── stock.go
│   └── provider_meta.go   # NEW: Provider metadata (tier, limits, etc.)
└── vm/                    # EXISTING: Verify compatibility with standardized metrics
    └── vm.go

tests/
├── contract/              # NEW: Provider contract tests
│   └── provider_test.go
├── integration/           # NEW: Provider switching and VM integration
│   ├── provider_switch_test.go
│   └── metrics_normalization_test.go
└── unit/                  # EXISTING: Add unit tests for new components
    └── provider/
        ├── alphavantage_test.go
        ├── polygon_test.go
        └── fmp_test.go

config.yaml                # EXISTING: Extend with provider configuration section
```

**Structure Decision**: Single Go project following existing internal/ structure. Provider implementations are packages under `internal/provider/`. Each provider (alphavantage, polygon, financialmodelingprep) is a separate subpackage implementing the StockProvider interface. The existing Polygon provider will be refactored to implement the new interface. TUI error panel added as new component in `internal/tui/`.

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | No violations | All principles satisfied |

---

## Phase 0: Research (COMPLETED)

**Status**: ✅ Complete - See [research.md](./research.md)

**Key Decisions Made**:
1. **Three providers selected**: Alpha Vantage (amateur), Polygon (professional), Financial Modeling Prep (quantitative)
2. **StockProvider interface**: Context-aware methods with GetQuote, GetQuotes, Name, HealthCheck
3. **Error handling**: Custom ProviderError with retry semantics
4. **Rate limiting**: Token bucket algorithm with configurable strategies
5. **Testing strategy**: Three-tier approach (contract tests, integration tests, unit tests)
6. **Configuration**: YAML config with environment variable overrides
7. **Observability**: Structured logging with metrics collection
8. **Provider registry**: Factory pattern with auto-registration
9. **Data normalization**: Always dollars, shares (int64), UTC timestamps, percentages as decimals
10. **Proactive rate adaptation**: System adapts refresh rates to provider plan capabilities

---

## Phase 1: Design (COMPLETED)

**Status**: ✅ Complete

### Data Model

**Location**: [data-model.md](./data-model.md)

**Core Entities**:
- **Quote**: Standardized real-time stock quote with Symbol, Price, Volume, Timestamp, Change, ChangePercent
- **Snapshot**: Extended market snapshot with DayOpen, DayHigh, DayLow, PrevClose
- **Provider**: Market data provider implementation with Name, Tier, RateLimit, RefreshInterval, DataLatency
- **ProviderConfig**: User configuration with APIKey, BaseURL, Timeout, Options
- **RateLimitInfo**: Rate limiting metadata with MaxRequests, Window, Strategy
- **ProviderError**: Domain error with Provider, Operation, StatusCode, Err, Retryable

**Key Design Decisions**:
- All prices in float64 dollars (never cents)
- All volumes in int64 shares
- All percentages as decimal (0.0123 = 1.23%)
- All timestamps in UTC timezone
- Validation: Price > 0, Volume >= 0, Symbol non-empty, Timestamp not future

### Contracts

**Location**: [contracts/](./contracts/)

**Generated Contracts**:
1. **StockProvider Interface** ([contracts/stock-provider-interface.md](./contracts/stock-provider-interface.md))
   - GetQuote(ctx, symbol) → Quote
   - GetQuotes(ctx, symbols) → []Quote
   - Name() → string
   - HealthCheck(ctx) → error

2. **Provider Configuration** ([contracts/provider-config.md](./contracts/provider-config.md))
   - YAML schema with provider selection, authentication, HTTP config, rate limiting, retry, circuit breaker
   - Environment variable substitution: ${VAR_NAME}
   - Validation at startup with fail-fast

3. **Provider Responses** ([contracts/provider-responses.md](./contracts/provider-responses.md))
   - Alpha Vantage: JSON with string fields, returns HTTP 200 for errors
   - Polygon: JSON with nested structure, proper HTTP status codes
   - FMP: JSON array, returns empty array for not found
   - Normalization rules for each provider

### Quickstart Guide

**Location**: [quickstart.md](./quickstart.md)

**Contents**:
- 5-minute setup for each provider tier
- Provider selection guide
- Configuration examples
- Screening script examples using standardized metrics
- Provider switching workflow
- Error handling and troubleshooting
- Provider comparison table

### Agent Context Update

**Status**: ✅ Complete - Agent context updated with new technologies:
- Provider abstraction pattern
- Token bucket rate limiting
- Exponential backoff retry
- Circuit breaker pattern
- Provider registry and factory

---

## Phase 2: Task Decomposition

**Status**: ✅ Complete - See [tasks.md](./tasks.md)

**Total Tasks**: 87 tasks organized by user story

**Task Breakdown**:
- Phase 1 - Setup: 4 tasks
- Phase 2 - Foundational: 14 tasks (BLOCKS all user stories)
- Phase 3 - User Story 1 (P1): 27 tasks - Provider switching
- Phase 4 - User Story 2 (P2): 7 tasks - Standardized metrics
- Phase 5 - User Story 3 (P3): 14 tasks - Advanced configuration
- Phase 6 - User Story 4 (P4): 5 tasks - Provider discovery
- Phase 7 - Polish: 16 tasks

**Parallel Opportunities**: 45 tasks marked [P] can run in parallel

**MVP Scope**: User Story 1 only (provider switching) delivers core value

---

## Implementation Notes

### Critical Path

1. **Foundational (Phase 2)**: Define StockProvider interface, normalization utils, middleware (rate limit, retry, circuit breaker)
2. **Provider Implementations (User Story 1)**: Alpha Vantage, Polygon (refactor), FMP implementations in parallel
3. **Engine Integration**: Update Engine to use StockProvider interface
4. **Configuration**: YAML config loader with environment variable substitution
5. **Standardized Metrics (User Story 2)**: VM integration with normalized Quote fields
6. **Advanced Configuration (User Story 3)**: Rate limiting, retry, circuit breaker configuration
7. **TUI Error Panel (Polish)**: Real-time provider error/warning display

### Key Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Provider API changes | High | Version detection, backward compatibility, graceful failure |
| Rate limit violations | Medium | Proactive rate adaptation, token bucket algorithm |
| Timezone inconsistencies | Medium | Normalize all timestamps to UTC immediately |
| Mid-session provider switching | Low | Warn user about data inconsistency, clear state |
| Performance degradation | Medium | Concurrent fetching, connection pooling, circuit breaker |

### Next Steps

1. Begin implementation with `/speckit.implement` or start Phase 1 - Setup manually
2. Follow TDD workflow: Write contract tests first (T017), ensure they fail, then implement providers
3. Test each provider independently before integration
4. Validate provider switching with integration tests
5. Complete MVP (User Story 1) before proceeding to additional stories

---

## References

- **Feature Specification**: [spec.md](./spec.md)
- **Research Document**: [research.md](./research.md)
- **Data Model**: [data-model.md](./data-model.md)
- **Contracts**: [contracts/](./contracts/)
- **Quickstart Guide**: [quickstart.md](./quickstart.md)
- **Task List**: [tasks.md](./tasks.md)
- **Constitution**: `.specify/memory/constitution.md`
